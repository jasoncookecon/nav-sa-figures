<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NAV Social Assistance - Complete Figure Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(90deg, #0f3460 0%, #16213e 100%);
            padding: 8px 20px;
            text-align: center;
            border-bottom: 2px solid #e94560;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header h1 { font-size: 1.3em; color: #fff; margin-bottom: 2px; display: inline; margin-right: 15px; }
        .header p { color: #a0a0a0; font-size: 0.85em; display: inline; }
        .header-title { margin-bottom: 6px; }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            align-items: center;
            margin-top: 6px;
            padding: 6px 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
        }
        .control-group {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 5px;
            position: relative;
        }
        .control-group > label {
            color: #00d9ff;
            font-weight: bold;
            font-size: 0.75em;
            white-space: nowrap;
        }

        /* Multi-select dropdown styles */
        .multi-select {
            position: relative;
            min-width: 140px;
        }
        .multi-select-btn {
            background: #1a1a2e;
            color: #e0e0e0;
            border: 1px solid #e94560;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            cursor: pointer;
            width: 100%;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .multi-select-btn:hover { border-color: #00d9ff; }
        .multi-select-btn::after {
            content: '▼';
            font-size: 0.7em;
            margin-left: 10px;
        }
        .multi-select-btn.open::after { content: '▲'; }

        .multi-select-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #1a1a2e;
            border: 2px solid #e94560;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 350px;
            overflow-y: auto;
            z-index: 1000;
        }
        .multi-select-dropdown.open { display: block; }

        .multi-select-option {
            padding: 4px 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8em;
            transition: background 0.2s;
        }
        .multi-select-option:hover { background: #0f3460; }
        .multi-select-option.selected { background: #0f3460; }
        .multi-select-option input[type="checkbox"] {
            accent-color: #e94560;
            width: 16px;
            height: 16px;
        }

        .multi-select-group-header {
            padding: 8px 12px;
            background: #0f3460;
            color: #00d9ff;
            font-weight: bold;
            font-size: 0.85em;
            border-top: 1px solid #333;
        }
        .multi-select-group-header:first-child { border-top: none; }

        .multi-select-actions {
            display: flex;
            gap: 5px;
            padding: 8px;
            border-top: 1px solid #333;
            background: #0f3460;
        }
        .multi-select-actions button {
            flex: 1;
            padding: 5px 10px;
            border: 1px solid #e94560;
            background: transparent;
            color: #e0e0e0;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
        }
        .multi-select-actions button:hover { background: #e94560; }

        .selected-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
            margin-left: 5px;
            max-width: 200px;
        }
        .selected-tag {
            background: #e94560;
            color: #fff;
            padding: 1px 5px;
            border-radius: 8px;
            font-size: 0.65em;
            display: flex;
            align-items: center;
            gap: 3px;
        }
        .selected-tag .remove {
            cursor: pointer;
            font-weight: bold;
        }
        .selected-tag .remove:hover { color: #ffcccc; }

        /* Standard select for figure type */
        select {
            background: #1a1a2e;
            color: #e0e0e0;
            border: 1px solid #e94560;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            cursor: pointer;
        }
        select:hover { border-color: #00d9ff; }

        .container { max-width: 1800px; margin: 0 auto; padding: 20px; }

        .section-title {
            font-size: 1.8em;
            color: #e94560;
            margin: 25px 0 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #333;
        }

        .outcome-section {
            background: #0f3460;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }
        .outcome-section h3 {
            color: #00d9ff;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .figure-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 15px;
        }
        .figure-card {
            background: #1e3a5f;
            border-radius: 10px;
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .figure-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(233,69,96,0.2);
        }
        .figure-card img {
            width: 100%;
            height: auto;
            display: block;
            cursor: pointer;
        }
        .figure-card .caption {
            padding: 10px;
            background: #0f3460;
            text-align: center;
        }
        .figure-card .caption .split-name {
            color: #e94560;
            font-weight: bold;
            font-size: 0.9em;
        }
        .figure-card .caption .split-desc {
            color: #a0a0a0;
            font-size: 0.8em;
        }

        .split-pair {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            background: #1e3a5f;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .split-pair h4 {
            grid-column: 1 / -1;
            color: #fff;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #333;
        }
        .split-pair .cell {
            text-align: center;
        }
        .split-pair .cell img {
            width: 100%;
            border-radius: 8px;
            cursor: pointer;
        }
        .split-pair .cell .label {
            margin-top: 5px;
            color: #a0a0a0;
            font-size: 0.85em;
        }

        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.75em;
            margin-left: 8px;
        }
        .badge-split { background: #e94560; color: #fff; }
        .badge-outcome { background: #00d9ff; color: #1a1a2e; }

        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        .modal.active { display: flex; }
        .modal img {
            max-width: 95%;
            max-height: 95%;
            border-radius: 10px;
        }

        .hidden { display: none !important; }

        .stats-bar {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 6px;
            flex-wrap: wrap;
        }
        .stat {
            background: rgba(0,0,0,0.3);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75em;
        }
        .stat .num { color: #e94560; font-weight: bold; }
        .stat .lbl { color: #a0a0a0; margin-left: 3px; }

        .filter-summary {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            font-size: 0.9em;
        }
        .filter-summary span { color: #00d9ff; }

        /* Print button styles */
        .print-btn {
            background: linear-gradient(135deg, #e94560 0%, #c73e54 100%);
            color: #fff;
            border: none;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(233,69,96,0.3);
        }
        .print-btn:hover {
            background: linear-gradient(135deg, #ff5a7a 0%, #e94560 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(233,69,96,0.4);
        }
        .print-btn svg { width: 14px; height: 14px; }

        /* Print header that shows filter settings */
        .print-header {
            display: none;
            background: #fff;
            color: #333;
            padding: 20px 30px;
            border-bottom: 3px solid #e94560;
            margin-bottom: 20px;
        }
        .print-header h1 {
            color: #1a1a2e;
            font-size: 24px;
            margin-bottom: 10px;
        }
        .print-header .print-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 15px;
        }
        .print-header .print-meta-item {
            background: #f5f5f5;
            padding: 8px 15px;
            border-radius: 8px;
            border-left: 4px solid #e94560;
        }
        .print-header .print-meta-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .print-header .print-meta-value {
            font-size: 14px;
            font-weight: bold;
            color: #1a1a2e;
            margin-top: 2px;
        }
        .print-header .print-timestamp {
            color: #888;
            font-size: 12px;
            margin-top: 15px;
        }

        /* Print-specific styles */
        @media print {
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }

            body {
                background: #fff !important;
                color: #333 !important;
                font-size: 10pt;
            }

            .header, .modal, .stats-bar { display: none !important; }

            .print-header { display: block !important; }

            .container {
                max-width: 100% !important;
                padding: 0 !important;
            }

            .section-title {
                color: #1a1a2e !important;
                font-size: 16pt !important;
                border-bottom: 2px solid #e94560 !important;
                page-break-before: auto;
                page-break-after: avoid;
                margin-top: 20px !important;
            }

            .outcome-section {
                background: #f8f9fa !important;
                border: 1px solid #ddd !important;
                border-radius: 8px !important;
                padding: 15px !important;
                margin-bottom: 15px !important;
                page-break-inside: avoid;
            }
            .outcome-section h3 {
                color: #1a1a2e !important;
                font-size: 12pt !important;
                border-bottom: 1px solid #ccc;
                padding-bottom: 8px;
                margin-bottom: 12px;
            }
            .outcome-section h4 {
                color: #333 !important;
                font-size: 10pt !important;
            }

            .badge {
                background: #e94560 !important;
                color: #fff !important;
                font-size: 8pt !important;
            }
            .badge-outcome {
                background: #00d9ff !important;
                color: #1a1a2e !important;
            }

            .figure-grid {
                display: grid !important;
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 10px !important;
            }

            .figure-card {
                background: #fff !important;
                border: 1px solid #ddd !important;
                border-radius: 6px !important;
                overflow: hidden;
                page-break-inside: avoid;
            }
            .figure-card img {
                width: 100% !important;
                height: auto !important;
            }
            .figure-card .caption {
                background: #f0f0f0 !important;
                padding: 6px !important;
                text-align: center;
            }
            .figure-card .split-name {
                color: #e94560 !important;
                font-weight: bold;
                font-size: 9pt;
            }
            .figure-card .split-desc {
                color: #666 !important;
                font-size: 8pt;
            }

            .split-pair {
                background: #fff !important;
                border: 1px solid #ddd !important;
                border-radius: 6px !important;
                padding: 10px !important;
                page-break-inside: avoid;
            }
            .split-pair h4 {
                color: #1a1a2e !important;
                border-bottom: 1px solid #eee;
                padding-bottom: 5px;
                margin-bottom: 8px;
            }
            .split-pair .cell .label {
                color: #666 !important;
                font-size: 8pt;
            }

            .hidden { display: none !important; }

            /* Ensure images don't break across pages */
            img { page-break-inside: avoid; }

            /* Add page numbers */
            @page {
                margin: 0.5in;
                @bottom-center {
                    content: "Page " counter(page) " of " counter(pages);
                }
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-title">
            <h1>NAV Figure Dashboard</h1>
            <p>Distributional & Standard Event Studies</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label>View:</label>
                <select id="viewModeSelect" onchange="switchViewMode()">
                    <option value="bySplit">By Split</option>
                    <option value="byOutcome">By Outcome</option>
                </select>
            </div>

            <div class="control-group">
                <label>Figure Type:</label>
                <select id="figTypeSelect" onchange="filterFigures()">
                    <option value="all">All Figures</option>
                    <option value="distributional">Distributional Only</option>
                    <option value="standard">Standard Event Study Only</option>
                </select>
            </div>

            <div class="control-group">
                <label>Sample:</label>
                <select id="sampleSelect" onchange="filterFigures()">
                    <option value="balanced">Balanced Panel</option>
                    <option value="unbalanced">Unbalanced Panel</option>
                </select>
            </div>

            <div class="control-group">
                <label>Outcomes:</label>
                <div class="multi-select" id="outcomeMultiSelect">
                    <button class="multi-select-btn" onclick="toggleDropdown('outcomeMultiSelect')">
                        <span class="btn-text">All Outcomes</span>
                    </button>
                    <div class="multi-select-dropdown">
                        <div class="multi-select-actions">
                            <button onclick="selectAll('outcomeMultiSelect')">Select All</button>
                            <button onclick="clearAll('outcomeMultiSelect')">Clear All</button>
                        </div>
                        <div class="multi-select-option" data-value="all">
                            <input type="checkbox" checked> All Outcomes
                        </div>

                        <div class="multi-select-group-header">Labor Market</div>
                        <div class="multi-select-option" data-value="employed_y"><input type="checkbox"> Employed</div>
                        <div class="multi-select-option" data-value="employed_0g"><input type="checkbox"> Employed (0g)</div>
                        <div class="multi-select-option" data-value="employed_1g"><input type="checkbox"> Employed (1g)</div>
                        <div class="multi-select-option" data-value="employed_2g"><input type="checkbox"> Employed (2g)</div>
                        <div class="multi-select-option" data-value="fulltime_y"><input type="checkbox"> Full-time</div>
                        <div class="multi-select-option" data-value="hours_y"><input type="checkbox"> Hours</div>
                        <div class="multi-select-option" data-value="in_educ_or_work"><input type="checkbox"> In Educ/Work</div>
                        <div class="multi-select-option" data-value="has_short_spell"><input type="checkbox"> Short Spell</div>
                        <div class="multi-select-option" data-value="has_short_spell_u"><input type="checkbox"> Short Spell (U)</div>

                        <div class="multi-select-group-header">Income</div>
                        <div class="multi-select-option" data-value="inc_tot"><input type="checkbox"> Total Income</div>
                        <div class="multi-select-option" data-value="inc_work"><input type="checkbox"> Labor Income</div>
                        <div class="multi-select-option" data-value="inc_wage"><input type="checkbox"> Wage Income</div>
                        <div class="multi-select-option" data-value="taxable_income"><input type="checkbox"> Taxable Income</div>
                        <div class="multi-select-option" data-value="inc_capital"><input type="checkbox"> Capital Income</div>
                        <div class="multi-select-option" data-value="wage_daily_mainjob"><input type="checkbox"> Daily Wage</div>
                        <div class="multi-select-option" data-value="wage_hourly_mainjob"><input type="checkbox"> Hourly Wage</div>

                        <div class="multi-select-group-header">Transfers</div>
                        <div class="multi-select-option" data-value="sa_transfers"><input type="checkbox"> SA Transfers</div>
                        <div class="multi-select-option" data-value="any_sa_transfers"><input type="checkbox"> Any SA</div>
                        <div class="multi-select-option" data-value="focal_trans_y"><input type="checkbox"> Focal Transfers</div>
                        <div class="multi-select-option" data-value="any_focal_trans_y"><input type="checkbox"> Any Focal Trans.</div>
                        <div class="multi-select-option" data-value="inc_trans_di"><input type="checkbox"> DI Transfers</div>
                        <div class="multi-select-option" data-value="any_inc_trans_di"><input type="checkbox"> Any DI</div>
                        <div class="multi-select-option" data-value="inc_trans_unemployment"><input type="checkbox"> UI Transfers</div>
                        <div class="multi-select-option" data-value="inc_trans_sick_leave"><input type="checkbox"> Sick Leave</div>
                        <div class="multi-select-option" data-value="inc_trans_work_assessment"><input type="checkbox"> Work Assessment</div>
                        <div class="multi-select-option" data-value="inc_trans_child_related"><input type="checkbox"> Child-Related</div>
                        <div class="multi-select-option" data-value="inc_trans_housing"><input type="checkbox"> Housing</div>
                        <div class="multi-select-option" data-value="inc_trans_sum_pension"><input type="checkbox"> Pension</div>
                        <div class="multi-select-option" data-value="inc_trans_medical_benefits"><input type="checkbox"> Medical</div>
                        <div class="multi-select-option" data-value="inc_other_transfers"><input type="checkbox"> Other Transfers</div>
                        <div class="multi-select-option" data-value="any_inc_other_transfers"><input type="checkbox"> Any Other Trans.</div>

                        <div class="multi-select-group-header">Education</div>
                        <div class="multi-select-option" data-value="ineduc"><input type="checkbox"> In Education</div>
                        <div class="multi-select-option" data-value="ineduc_highschool"><input type="checkbox"> In HS</div>
                        <div class="multi-select-option" data-value="ineduc_college"><input type="checkbox"> In College</div>
                        <div class="multi-select-option" data-value="ineduc_primary"><input type="checkbox"> In Primary</div>
                        <div class="multi-select-option" data-value="inc_trans_scholarship"><input type="checkbox"> Scholarship</div>

                        <div class="multi-select-group-header">Family</div>
                        <div class="multi-select-option" data-value="n_children"><input type="checkbox"> N Children</div>
                        <div class="multi-select-option" data-value="has_spouse"><input type="checkbox"> Has Spouse</div>
                        <div class="multi-select-option" data-value="married"><input type="checkbox"> Married</div>
                        <div class="multi-select-option" data-value="cohabitation"><input type="checkbox"> Cohabitation</div>
                        <div class="multi-select-option" data-value="separation"><input type="checkbox"> Separation</div>
                        <div class="multi-select-option" data-value="union"><input type="checkbox"> Union</div>

                        <div class="multi-select-group-header">Mobility</div>
                        <div class="multi-select-option" data-value="reloc_any"><input type="checkbox"> Any Relocation</div>
                        <div class="multi-select-option" data-value="reloc_within_mun"><input type="checkbox"> Within Muni.</div>
                        <div class="multi-select-option" data-value="reloc_across_mun"><input type="checkbox"> Across Muni.</div>

                        <div class="multi-select-group-header">Wealth</div>
                        <div class="multi-select-option" data-value="wealth_net"><input type="checkbox"> Net Wealth</div>
                        <div class="multi-select-option" data-value="wealth_net_wins1"><input type="checkbox"> Net Wealth (wins1)</div>
                        <div class="multi-select-option" data-value="wealth_net_wins5"><input type="checkbox"> Net Wealth (wins5)</div>
                        <div class="multi-select-option" data-value="wealth_housing"><input type="checkbox"> Housing Wealth</div>
                        <div class="multi-select-option" data-value="wealth_housing_wins1"><input type="checkbox"> Housing (wins1)</div>
                        <div class="multi-select-option" data-value="wealth_housing_wins5"><input type="checkbox"> Housing (wins5)</div>

                        <div class="multi-select-group-header">Distributional</div>
                        <div class="multi-select-option" data-value="inc_tot_gt_p"><input type="checkbox"> Total Income (dist)</div>
                        <div class="multi-select-option" data-value="inc_work_gt_p"><input type="checkbox"> Labor Income (dist)</div>
                        <div class="multi-select-option" data-value="inc_wage_gt_p"><input type="checkbox"> Wage Income (dist)</div>
                        <div class="multi-select-option" data-value="taxable_income_gt_p"><input type="checkbox"> Taxable Income (dist)</div>
                    </div>
                </div>
                <div class="selected-tags" id="outcomeTags"></div>
            </div>

            <div class="control-group">
                <label>Splits:</label>
                <div class="multi-select" id="splitMultiSelect">
                    <button class="multi-select-btn" onclick="toggleDropdown('splitMultiSelect')">
                        <span class="btn-text">All Splits</span>
                    </button>
                    <div class="multi-select-dropdown" id="splitDropdownContent">
                        <!-- Dynamically populated by JavaScript -->
                    </div>
                </div>
                <div class="selected-tags" id="splitTags"></div>
            </div>
        </div>

        <div class="stats-bar">
            <div class="stat"><span class="num" id="splitCount">--</span><span class="lbl">Splits</span></div>
            <div class="stat"><span class="num">50+</span><span class="lbl">Outcomes</span></div>
            <div class="stat"><span class="num" id="visibleCount">All</span><span class="lbl">Showing</span></div>
            <button class="print-btn" onclick="printReport()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="6 9 6 2 18 2 18 9"></polyline>
                    <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                    <rect x="6" y="14" width="12" height="8"></rect>
                </svg>
                Print / PDF
            </button>
        </div>
    </div>

    <!-- Print header (only visible when printing) -->
    <div class="print-header" id="printHeader">
        <h1>NAV Social Assistance - Figure Comparison Report</h1>
        <p style="color: #666;">Distributional & Standard Event Studies</p>
        <div class="print-meta" id="printMeta">
            <!-- Populated by JavaScript -->
        </div>
        <div class="print-timestamp" id="printTimestamp"></div>
    </div>

    <!-- Container for "By Split" view (default) -->
    <div class="container" id="bySplitContainer">
        <!-- FULL SAMPLE SECTION -->
        <h2 class="section-title" data-category-header="fullsample">Full Sample (all)</h2>

        <div class="outcome-section" data-split="all-split" data-category="distributional" data-type="distributional">
            <h3>Distributional Income <span class="badge badge-outcome">Ridgeline Plots</span></h3>
            <p style="color: #a0a0a0; margin-bottom: 15px; font-size: 0.9em;">Effects across the income distribution (p10-p90 thresholds). Shows Amount, Duration, and Amount×Duration treatments.</p>
            <div class="figure-grid">
                <!-- Amount × Duration -->
                <div class="figure-card">
                    <img class="sample-img" data-base="figs/all/distributional_eventstudy_all_inc_tot_gt_p_amt_dur_pooled" data-suffix="_noronly.png" onclick="openModal(this)" onerror="this.parentElement.style.display='none'">
                    <div class="caption"><div class="split-name">Total Income</div><div class="split-desc">Amount × Duration</div></div>
                </div>
                <div class="figure-card">
                    <img class="sample-img" data-base="figs/all/distributional_eventstudy_all_inc_work_gt_p_amt_dur_pooled" data-suffix="_noronly.png" onclick="openModal(this)" onerror="this.parentElement.style.display='none'">
                    <div class="caption"><div class="split-name">Labor Income</div><div class="split-desc">Amount × Duration</div></div>
                </div>
                <div class="figure-card">
                    <img class="sample-img" data-base="figs/all/distributional_eventstudy_all_inc_wage_gt_p_amt_dur_pooled" data-suffix="_noronly.png" onclick="openModal(this)" onerror="this.parentElement.style.display='none'">
                    <div class="caption"><div class="split-name">Wage Income</div><div class="split-desc">Amount × Duration</div></div>
                </div>
                <div class="figure-card">
                    <img class="sample-img" data-base="figs/all/distributional_eventstudy_all_taxable_income_gt_p_amt_dur_pooled" data-suffix="_noronly.png" onclick="openModal(this)" onerror="this.parentElement.style.display='none'">
                    <div class="caption"><div class="split-name">Taxable Income</div><div class="split-desc">Amount × Duration</div></div>
                </div>
                <!-- Amount Only -->
                <div class="figure-card">
                    <img class="sample-img" data-base="figs/all/distributional_eventstudy_all_inc_tot_gt_p_amt_pooled" data-suffix="_noronly.png" onclick="openModal(this)" onerror="this.parentElement.style.display='none'">
                    <div class="caption"><div class="split-name">Total Income</div><div class="split-desc">Amount Only</div></div>
                </div>
                <div class="figure-card">
                    <img class="sample-img" data-base="figs/all/distributional_eventstudy_all_inc_work_gt_p_amt_pooled" data-suffix="_noronly.png" onclick="openModal(this)" onerror="this.parentElement.style.display='none'">
                    <div class="caption"><div class="split-name">Labor Income</div><div class="split-desc">Amount Only</div></div>
                </div>
                <div class="figure-card">
                    <img class="sample-img" data-base="figs/all/distributional_eventstudy_all_inc_wage_gt_p_amt_pooled" data-suffix="_noronly.png" onclick="openModal(this)" onerror="this.parentElement.style.display='none'">
                    <div class="caption"><div class="split-name">Wage Income</div><div class="split-desc">Amount Only</div></div>
                </div>
                <div class="figure-card">
                    <img class="sample-img" data-base="figs/all/distributional_eventstudy_all_taxable_income_gt_p_amt_pooled" data-suffix="_noronly.png" onclick="openModal(this)" onerror="this.parentElement.style.display='none'">
                    <div class="caption"><div class="split-name">Taxable Income</div><div class="split-desc">Amount Only</div></div>
                </div>
                <!-- Duration Only -->
                <div class="figure-card">
                    <img class="sample-img" data-base="figs/all/distributional_eventstudy_all_inc_tot_gt_p_dur_pooled" data-suffix="_noronly.png" onclick="openModal(this)" onerror="this.parentElement.style.display='none'">
                    <div class="caption"><div class="split-name">Total Income</div><div class="split-desc">Duration Only</div></div>
                </div>
                <div class="figure-card">
                    <img class="sample-img" data-base="figs/all/distributional_eventstudy_all_inc_work_gt_p_dur_pooled" data-suffix="_noronly.png" onclick="openModal(this)" onerror="this.parentElement.style.display='none'">
                    <div class="caption"><div class="split-name">Labor Income</div><div class="split-desc">Duration Only</div></div>
                </div>
                <div class="figure-card">
                    <img class="sample-img" data-base="figs/all/distributional_eventstudy_all_inc_wage_gt_p_dur_pooled" data-suffix="_noronly.png" onclick="openModal(this)" onerror="this.parentElement.style.display='none'">
                    <div class="caption"><div class="split-name">Wage Income</div><div class="split-desc">Duration Only</div></div>
                </div>
                <div class="figure-card">
                    <img class="sample-img" data-base="figs/all/distributional_eventstudy_all_taxable_income_gt_p_dur_pooled" data-suffix="_noronly.png" onclick="openModal(this)" onerror="this.parentElement.style.display='none'">
                    <div class="caption"><div class="split-name">Taxable Income</div><div class="split-desc">Duration Only</div></div>
                </div>
            </div>
        </div>

        <!-- SPLITS WITH ALL OUTCOMES - Generated by JavaScript -->
        <script>
            // ============================================================
            // AUTO-CATEGORIZATION SYSTEM FOR SPLITS
            // When you add new splits, they will be auto-categorized based on naming patterns
            // ============================================================

            // Helper function to auto-generate labels based on split name
            function generateSplitLabels(name) {
                // Extract percentile if present
                const pMatch = name.match(/_p(\d+)(_|$)/);
                const percentile = pMatch ? pMatch[1] : null;

                // For p25 splits: split_level==1 means < p25 (low group)
                // For p50/p75 splits: split_level==1 means >= pXX (high group)
                const isP25 = percentile === '25';

                // Base label patterns
                if (name.startsWith('HHI_')) {
                    const suffix = percentile ? `p${percentile}` : '';
                    if (isP25) {
                        return { label0: `High HHI (>=${suffix})`, label1: `Low HHI (<${suffix})` };
                    }
                    return { label0: `Low HHI (<${suffix})`, label1: `High HHI (>=${suffix})` };
                }
                if (name.startsWith('urate_')) {
                    const suffix = percentile ? `p${percentile}` : '';
                    if (isP25) {
                        return { label0: `High Urate (>=${suffix})`, label1: `Low Urate (<${suffix})` };
                    }
                    return { label0: `Low Urate (<${suffix})`, label1: `High Urate (>=${suffix})` };
                }
                if (name.startsWith('epop_')) {
                    const suffix = percentile ? `p${percentile}` : '';
                    if (isP25) {
                        return { label0: `High Emp-Pop (>=${suffix})`, label1: `Low Emp-Pop (<${suffix})` };
                    }
                    return { label0: `Low Emp-Pop (<${suffix})`, label1: `High Emp-Pop (>=${suffix})` };
                }
                if (name.startsWith('llm_shortspl_')) {
                    const suffix = percentile ? `p${percentile}` : '';
                    if (isP25) {
                        return { label0: `High Short Spell (>=${suffix})`, label1: `Low Short Spell (<${suffix})` };
                    }
                    return { label0: `Low Short Spell (<${suffix})`, label1: `High Short Spell (>=${suffix})` };
                }
                if (name.startsWith('sick_')) {
                    const suffix = percentile ? `p${percentile}` : '';
                    if (isP25) {
                        return { label0: `High Sick Leave (>=${suffix})`, label1: `Low Sick Leave (<${suffix})` };
                    }
                    return { label0: `Low Sick Leave (<${suffix})`, label1: `High Sick Leave (>=${suffix})` };
                }
                if (name.startsWith('wage_')) {
                    const suffix = percentile ? `p${percentile}` : '';
                    if (isP25) {
                        return { label0: `High Wage (>=${suffix})`, label1: `Low Wage (<${suffix})` };
                    }
                    return { label0: `Low Wage (<${suffix})`, label1: `High Wage (>=${suffix})` };
                }
                if (name.startsWith('pop_density_') || name === 'rural') {
                    if (name === 'rural') return { label0: 'Urban', label1: 'Rural' };
                    const suffix = percentile ? `p${percentile}` : '';
                    return { label0: `Low Density (<${suffix})`, label1: `High Density (>=${suffix})` };
                }
                if (name.startsWith('muni_inc_')) {
                    const suffix = percentile ? `p${percentile}` : '';
                    return { label0: `Low Muni Inc (<${suffix})`, label1: `High Muni Inc (>=${suffix})` };
                }
                // Binary demographic splits
                if (name === 'female') return { label0: 'Male', label1: 'Female' };
                if (name === 'employed_tm1') return { label0: 'Not Employed (t-1)', label1: 'Employed (t-1)' };
                if (name === 'single_tm1') return { label0: 'Not Single (t-1)', label1: 'Single (t-1)' };
                if (name === 'homeless') return { label0: 'Not Homeless', label1: 'Homeless' };
                if (name === 'student') return { label0: 'Not Student', label1: 'Student' };
                if (name === 'ineduc_tm1') return { label0: 'Not in Educ (t-1)', label1: 'In Educ (t-1)' };
                if (name === 'has_kids_tm1') return { label0: 'No Kids (t-1)', label1: 'Has Kids (t-1)' };
                if (name === 'union') return { label0: 'Not in Union', label1: 'In Union' };
                // LLM composite
                if (name === 'llm_best') return { label0: 'Worse LLM', label1: 'Best LLM (Low HHI & Urate)' };
                if (name === 'llm_worst') return { label0: 'Better LLM', label1: 'Worst LLM (High HHI & Urate)' };
                // Life events
                if (name.includes('death')) return { label0: 'No Death Event', label1: 'Death Event' };
                if (name.includes('shock')) return { label0: 'No Shock', label1: 'Shock' };
                if (name.includes('EtoU')) return { label0: 'No E-to-U', label1: 'E-to-U Transition' };
                if (name.includes('hs_dropout')) return { label0: 'Not HS Dropout', label1: 'HS Dropout' };
                if (name.includes('hs_start')) return { label0: 'Did Not Start HS', label1: 'Started HS' };
                if (name.includes('educ_event')) return { label0: 'No Educ Event', label1: 'Educ Event' };
                // Default
                return { label0: 'Group 0', label1: 'Group 1' };
            }

            // Helper function to auto-categorize splits
            function categorize(name) {
                if (name.startsWith('HHI_')) return 'hhi';
                if (name.startsWith('urate_')) return 'unemployment';
                if (name.startsWith('epop_')) return 'epop';
                if (name.startsWith('llm_shortspl_')) return 'shortspell';
                if (name.startsWith('sick_')) return 'sickleave';
                if (name.startsWith('wage_') || name.startsWith('muni_inc_')) return 'wages';
                if (name.startsWith('pop_density_') || name === 'rural') return 'density';
                if (name === 'llm_best' || name === 'llm_worst') return 'llm_composite';
                if (['female', 'employed_tm1', 'single_tm1', 'homeless', 'student', 'ineduc_tm1', 'has_kids_tm1'].includes(name)) return 'demographics';
                if (name.includes('death') || name.includes('shock') || name.includes('EtoU') || name.includes('hs_')) return 'events';
                if (name === 'union') return 'demographics';
                return 'other';
            }

            // MASTER LIST OF ALL SPLITS - add new splits here and they auto-categorize
            const allSplitNames = [
                // HHI Education-based
                'HHI_educ_p25', 'HHI_educ_p25_byeduc', 'HHI_educ_p50', 'HHI_educ_p50_byeduc', 'HHI_educ_p75', 'HHI_educ_p75_byeduc',
                // HHI Municipality-based
                'HHI_mun_p25', 'HHI_mun_p50', 'HHI_mun_p75',
                // HHI Occupation-based
                'HHI_occ1_p25', 'HHI_occ1_p50', 'HHI_occ1_p75',
                'HHI_occ2_p25', 'HHI_occ2_p50', 'HHI_occ2_p75',
                'HHI_occ3_p25', 'HHI_occ3_p50', 'HHI_occ3_p75',
                // HHI Mean
                'HHI_mean_educ_p25', 'HHI_mean_educ_p50', 'HHI_mean_educ_p75',
                'HHI_mean_occ2_p25', 'HHI_mean_occ2_p50', 'HHI_mean_occ2_p75',
                // Unemployment LLM
                'urate_llm_p25', 'urate_llm_p50', 'urate_llm_p75',
                // Unemployment Municipality
                'urate_mun_p25', 'urate_mun_p50', 'urate_mun_p75',
                // Employment-to-Population
                'epop_p25', 'epop_p50', 'epop_p75',
                // Short Spell Rate
                'llm_shortspl_p25', 'llm_shortspl_p50', 'llm_shortspl_p75',
                // Sick Leave
                'sick_llm_p25', 'sick_llm_p50', 'sick_llm_p75',
                'sick_mun_p25', 'sick_mun_p50', 'sick_mun_p75',
                // Wages
                'wage_daily_p25', 'wage_daily_p50', 'wage_daily_p75',
                'wage_hourly_p25', 'wage_hourly_p50', 'wage_hourly_p75',
                'muni_inc_p25', 'muni_inc_p50', 'muni_inc_p75',
                // Population Density
                'pop_density_p25', 'pop_density_p50', 'pop_density_p75', 'rural',
                // LLM Composite
                'llm_best', 'llm_worst',
                // Demographics
                'female', 'employed_tm1', 'single_tm1', 'homeless', 'student', 'ineduc_tm1', 'has_kids_tm1', 'union',
                // Life Events / Shocks
                'any_family_death_tm2_t', 'any_close_death_tm2_t', 'any_family_shock_t',
                'any_employment_shock', 'any_educ_event_t_tm1', 'any_econ_shock',
                'EtoU_0g_tm1', 'EtoU_1g_tm1',
                'hs_dropout_tm1', 'hs_start_t_tm1'
            ];

            // Build splits array with auto-generated labels and categories
            const splits = allSplitNames.map(name => {
                const labels = generateSplitLabels(name);
                return {
                    name: name,
                    label0: labels.label0,
                    label1: labels.label1,
                    category: categorize(name)
                };
            });

            // Sort splits by category then name
            const categoryOrder = ['hhi', 'unemployment', 'epop', 'shortspell', 'sickleave', 'wages', 'density', 'llm_composite', 'demographics', 'events', 'other'];
            splits.sort((a, b) => {
                const catDiff = categoryOrder.indexOf(a.category) - categoryOrder.indexOf(b.category);
                if (catDiff !== 0) return catDiff;
                return a.name.localeCompare(b.name);
            });

            // Define all outcomes grouped by category (distributional + standard)
            // Based on actual files in HHI_educ_p50 directory
            const outcomeGroups = {
                labor: {
                    title: 'Labor Market Outcomes',
                    outcomes: [
                        {name: 'employed_y', label: 'Employed'},
                        {name: 'employed_0g', label: 'Employed (0g)'},
                        {name: 'employed_1g', label: 'Employed (1g)'},
                        {name: 'employed_2g', label: 'Employed (2g)'},
                        {name: 'fulltime_y', label: 'Full-time'},
                        {name: 'hours_y', label: 'Hours'},
                        {name: 'in_educ_or_work', label: 'In Educ/Work'},
                        {name: 'has_short_spell', label: 'Short Spell'},
                        {name: 'has_short_spell_u', label: 'Short Spell (U)'},
                    ]
                },
                income: {
                    title: 'Income Outcomes',
                    outcomes: [
                        {name: 'inc_tot', label: 'Total Income'},
                        {name: 'inc_work', label: 'Labor Income'},
                        {name: 'inc_wage', label: 'Wage Income'},
                        {name: 'taxable_income', label: 'Taxable Income'},
                        {name: 'inc_capital', label: 'Capital Income'},
                        {name: 'wage_daily_mainjob', label: 'Daily Wage (Main)'},
                        {name: 'wage_hourly_mainjob', label: 'Hourly Wage (Main)'},
                    ]
                },
                transfers: {
                    title: 'Transfer Outcomes',
                    outcomes: [
                        {name: 'sa_transfers', label: 'SA Transfers'},
                        {name: 'any_sa_transfers', label: 'Any SA'},
                        {name: 'focal_trans_y', label: 'Focal Transfers'},
                        {name: 'any_focal_trans_y', label: 'Any Focal Trans.'},
                        {name: 'inc_trans_di', label: 'DI Transfers'},
                        {name: 'any_inc_trans_di', label: 'Any DI'},
                        {name: 'inc_trans_unemployment', label: 'UI Transfers'},
                        {name: 'inc_trans_sick_leave', label: 'Sick Leave'},
                        {name: 'inc_trans_work_assessment', label: 'Work Assessment'},
                        {name: 'inc_trans_child_related', label: 'Child-Related'},
                        {name: 'inc_trans_housing', label: 'Housing'},
                        {name: 'inc_trans_sum_pension', label: 'Pension'},
                        {name: 'inc_trans_medical_benefits', label: 'Medical'},
                        {name: 'inc_other_transfers', label: 'Other Transfers'},
                        {name: 'any_inc_other_transfers', label: 'Any Other Trans.'},
                    ]
                },
                education: {
                    title: 'Education Outcomes',
                    outcomes: [
                        {name: 'ineduc', label: 'In Education'},
                        {name: 'ineduc_highschool', label: 'In HS'},
                        {name: 'ineduc_college', label: 'In College'},
                        {name: 'ineduc_primary', label: 'In Primary'},
                        {name: 'inc_trans_scholarship', label: 'Scholarship'},
                    ]
                },
                family: {
                    title: 'Family Outcomes',
                    outcomes: [
                        {name: 'n_children', label: 'N Children'},
                        {name: 'has_spouse', label: 'Has Spouse'},
                        {name: 'married', label: 'Married'},
                        {name: 'cohabitation', label: 'Cohabitation'},
                        {name: 'separation', label: 'Separation'},
                        {name: 'union', label: 'Union'},
                    ]
                },
                mobility: {
                    title: 'Mobility Outcomes',
                    outcomes: [
                        {name: 'reloc_any', label: 'Any Relocation'},
                        {name: 'reloc_within_mun', label: 'Within Muni.'},
                        {name: 'reloc_across_mun', label: 'Across Muni.'},
                    ]
                },
                wealth: {
                    title: 'Wealth Outcomes',
                    outcomes: [
                        {name: 'wealth_net', label: 'Net Wealth'},
                        {name: 'wealth_net_wins1', label: 'Net Wealth (wins1)'},
                        {name: 'wealth_net_wins5', label: 'Net Wealth (wins5)'},
                        {name: 'wealth_housing', label: 'Housing Wealth'},
                        {name: 'wealth_housing_wins1', label: 'Housing Wealth (wins1)'},
                        {name: 'wealth_housing_wins5', label: 'Housing Wealth (wins5)'},
                    ]
                },
                distributional: {
                    title: 'Distributional Income',
                    outcomes: [
                        {name: 'inc_tot_gt_p', label: 'Total Income', isDistributional: true},
                        {name: 'inc_work_gt_p', label: 'Labor Income', isDistributional: true},
                        {name: 'inc_wage_gt_p', label: 'Wage Income', isDistributional: true},
                        {name: 'taxable_income_gt_p', label: 'Taxable Income', isDistributional: true},
                    ]
                }
            };

            // Generate HTML for all splits
            function generateSplitSections() {
                const container = document.getElementById('bySplitContainer');

                const categoryTitles = {
                    hhi: 'HHI Concentration Splits',
                    unemployment: 'Unemployment Rate Splits',
                    epop: 'Employment-to-Population Splits',
                    shortspell: 'Short Spell Rate Splits',
                    sickleave: 'Sick Leave Rate Splits',
                    wages: 'Wage & Income Splits',
                    density: 'Population Density Splits',
                    llm_composite: 'LLM Composite Splits',
                    demographics: 'Demographic Splits',
                    events: 'Life Events & Shocks',
                    other: 'Other Splits'
                };

                let currentCategory = '';

                splits.forEach(split => {
                    if (split.category !== currentCategory) {
                        currentCategory = split.category;
                        const header = document.createElement('h2');
                        header.className = 'section-title';
                        header.textContent = categoryTitles[currentCategory];
                        header.setAttribute('data-category-header', currentCategory);
                        container.appendChild(header);
                    }

                    const splitSection = document.createElement('div');
                    splitSection.className = 'outcome-section';
                    splitSection.setAttribute('data-split', split.name);
                    splitSection.innerHTML = `<h3>${split.name} <span class="badge badge-split">${split.label0} vs ${split.label1}</span></h3>`;

                    Object.entries(outcomeGroups).forEach(([groupKey, group]) => {
                        const groupDiv = document.createElement('div');
                        groupDiv.style.marginBottom = '20px';
                        groupDiv.setAttribute('data-category', groupKey);
                        groupDiv.setAttribute('data-type', groupKey === 'distributional' ? 'distributional' : 'standard');

                        groupDiv.innerHTML = `<h4 style="color: #00d9ff; margin-bottom: 10px; font-size: 1.1em;">${group.title}</h4>`;

                        const grid = document.createElement('div');
                        grid.className = 'figure-grid';

                        group.outcomes.forEach(outcome => {
                            if (outcome.isDistributional) {
                                const pairDiv = document.createElement('div');
                                pairDiv.className = 'split-pair';
                                pairDiv.setAttribute('data-outcome', outcome.name);
                                pairDiv.innerHTML = `
                                    <h4>${outcome.label}</h4>
                                    <div class="cell">
                                        <img class="sample-img" data-base="figs/${split.name}/distributional_eventstudy_${split.name}_${outcome.name}_amt_dur_split0" data-suffix="_noronly.png"
                                             onclick="openModal(this)" onerror="this.parentElement.parentElement.style.display='none'">
                                        <div class="label">${split.label0}</div>
                                    </div>
                                    <div class="cell">
                                        <img class="sample-img" data-base="figs/${split.name}/distributional_eventstudy_${split.name}_${outcome.name}_amt_dur_split1" data-suffix="_noronly.png"
                                             onclick="openModal(this)" onerror="this.style.display='none'">
                                        <div class="label">${split.label1}</div>
                                    </div>
                                `;
                                grid.appendChild(pairDiv);
                            } else {
                                const card = document.createElement('div');
                                card.className = 'figure-card';
                                card.setAttribute('data-outcome', outcome.name);
                                card.innerHTML = `
                                    <img class="sample-img" data-base="figs/${split.name}/eventstudy_${split.name}_${outcome.name}_amt_dur" data-suffix="_noronly.png"
                                         onclick="openModal(this)" onerror="this.parentElement.style.display='none'">
                                    <div class="caption">
                                        <div class="split-name">${outcome.label}</div>
                                    </div>
                                `;
                                grid.appendChild(card);
                            }
                        });

                        groupDiv.appendChild(grid);
                        splitSection.appendChild(groupDiv);
                    });

                    container.appendChild(splitSection);
                });
            }

            // Generate HTML for "By Outcome" view - outcomes as main sections, splits within
            function generateOutcomeSections() {
                const container = document.getElementById('byOutcomeContainer');

                Object.entries(outcomeGroups).forEach(([groupKey, group]) => {
                    // Add category header
                    const header = document.createElement('h2');
                    header.className = 'section-title';
                    header.textContent = group.title;
                    header.setAttribute('data-outcome-category-header', groupKey);
                    container.appendChild(header);

                    // Create a section for each outcome in this category
                    group.outcomes.forEach(outcome => {
                        const outcomeSection = document.createElement('div');
                        outcomeSection.className = 'outcome-section';
                        outcomeSection.setAttribute('data-outcome-view', outcome.name);
                        outcomeSection.setAttribute('data-type', outcome.isDistributional ? 'distributional' : 'standard');

                        outcomeSection.innerHTML = `<h3>${outcome.label} <span class="badge badge-outcome">${outcome.isDistributional ? 'Distributional' : 'Standard'}</span></h3>`;

                        const grid = document.createElement('div');
                        grid.className = 'figure-grid';

                        // FIRST: Add Full Sample figure(s)
                        if (outcome.isDistributional) {
                            // For distributional outcomes in full sample, show pooled figure
                            const fullSampleCard = document.createElement('div');
                            fullSampleCard.className = 'figure-card';
                            fullSampleCard.setAttribute('data-split-view', 'all-split');
                            fullSampleCard.style.border = '2px solid #e94560'; // Highlight full sample
                            fullSampleCard.innerHTML = `
                                <img class="sample-img" data-base="figs/all/distributional_eventstudy_all_${outcome.name}_amt_dur_pooled" data-suffix="_noronly.png"
                                     onclick="openModal(this)" onerror="this.parentElement.style.display='none'">
                                <div class="caption">
                                    <div class="split-name" style="color: #e94560;">Full Sample</div>
                                    <div class="split-desc">All Observations (Pooled)</div>
                                </div>
                            `;
                            grid.appendChild(fullSampleCard);
                        } else {
                            // Standard outcomes - full sample figure
                            const fullSampleCard = document.createElement('div');
                            fullSampleCard.className = 'figure-card';
                            fullSampleCard.setAttribute('data-split-view', 'all-split');
                            fullSampleCard.style.border = '2px solid #e94560'; // Highlight full sample
                            fullSampleCard.innerHTML = `
                                <img class="sample-img" data-base="figs/all/eventstudy_all_${outcome.name}_amt_dur" data-suffix="_noronly.png"
                                     onclick="openModal(this)" onerror="this.parentElement.style.display='none'">
                                <div class="caption">
                                    <div class="split-name" style="color: #e94560;">Full Sample</div>
                                    <div class="split-desc">All Observations</div>
                                </div>
                            `;
                            grid.appendChild(fullSampleCard);
                        }

                        // THEN: Add figures for each split
                        splits.forEach(split => {
                            if (outcome.isDistributional) {
                                // For distributional outcomes, show split0 and split1 side by side
                                const pairDiv = document.createElement('div');
                                pairDiv.className = 'split-pair';
                                pairDiv.setAttribute('data-split-view', split.name);
                                pairDiv.innerHTML = `
                                    <h4>${split.name}</h4>
                                    <div class="cell">
                                        <img class="sample-img" data-base="figs/${split.name}/distributional_eventstudy_${split.name}_${outcome.name}_amt_dur_split0" data-suffix="_noronly.png"
                                             onclick="openModal(this)" onerror="this.parentElement.parentElement.style.display='none'">
                                        <div class="label">${split.label0}</div>
                                    </div>
                                    <div class="cell">
                                        <img class="sample-img" data-base="figs/${split.name}/distributional_eventstudy_${split.name}_${outcome.name}_amt_dur_split1" data-suffix="_noronly.png"
                                             onclick="openModal(this)" onerror="this.style.display='none'">
                                        <div class="label">${split.label1}</div>
                                    </div>
                                `;
                                grid.appendChild(pairDiv);
                            } else {
                                // Standard outcomes - one card per split
                                const card = document.createElement('div');
                                card.className = 'figure-card';
                                card.setAttribute('data-split-view', split.name);
                                card.innerHTML = `
                                    <img class="sample-img" data-base="figs/${split.name}/eventstudy_${split.name}_${outcome.name}_amt_dur" data-suffix="_noronly.png"
                                         onclick="openModal(this)" onerror="this.parentElement.style.display='none'">
                                    <div class="caption">
                                        <div class="split-name">${split.name}</div>
                                        <div class="split-desc">${split.label0} vs ${split.label1}</div>
                                    </div>
                                `;
                                grid.appendChild(card);
                            }
                        });

                        outcomeSection.appendChild(grid);
                        container.appendChild(outcomeSection);
                    });
                });
            }

            // Dynamically populate the split filter dropdown
            function populateSplitDropdown() {
                const dropdown = document.getElementById('splitDropdownContent');

                const categoryTitles = {
                    hhi: 'HHI Concentration',
                    unemployment: 'Unemployment Rate',
                    epop: 'Employment-to-Population',
                    shortspell: 'Short Spell Rate',
                    sickleave: 'Sick Leave Rate',
                    wages: 'Wage & Income',
                    density: 'Population Density',
                    llm_composite: 'LLM Composite',
                    demographics: 'Demographics',
                    events: 'Life Events & Shocks',
                    other: 'Other'
                };

                let html = `
                    <div class="multi-select-actions">
                        <button onclick="selectAll('splitMultiSelect')">Select All</button>
                        <button onclick="clearAll('splitMultiSelect')">Clear All</button>
                    </div>
                    <div class="multi-select-option" data-value="all">
                        <input type="checkbox" checked> All Splits
                    </div>
                    <div class="multi-select-group-header">Full Sample</div>
                    <div class="multi-select-option" data-value="all-split">
                        <input type="checkbox"> all (Full Sample)
                    </div>
                `;

                let currentCategory = '';
                splits.forEach(split => {
                    if (split.category !== currentCategory) {
                        currentCategory = split.category;
                        html += `<div class="multi-select-group-header">${categoryTitles[currentCategory] || currentCategory}</div>`;
                    }
                    html += `<div class="multi-select-option" data-value="${split.name}"><input type="checkbox"> ${split.name}</div>`;
                });

                dropdown.innerHTML = html;

                // Update split count in stats bar
                document.getElementById('splitCount').textContent = splits.length;

                // Re-attach event listeners for dynamically created options
                dropdown.querySelectorAll('.multi-select-option').forEach(option => {
                    option.addEventListener('click', function(e) {
                        if (e.target.tagName === 'INPUT') return;
                        const checkbox = this.querySelector('input[type="checkbox"]');
                        checkbox.checked = !checkbox.checked;
                        handleOptionChange(this);
                    });

                    option.querySelector('input').addEventListener('change', function() {
                        handleOptionChange(option);
                    });
                });
            }

            document.addEventListener('DOMContentLoaded', function() {
                populateSplitDropdown();
                generateSplitSections();
                generateOutcomeSections();
                // Initialize image sources after sections are generated
                filterFigures();
            });
        </script>
    </div>

    <!-- Container for "By Outcome" view (hidden by default) -->
    <div class="container hidden" id="byOutcomeContainer">
        <!-- Generated by JavaScript: generateOutcomeSections() -->
    </div>

    <!-- Modal -->
    <div id="modal" class="modal" onclick="closeModal()">
        <img id="modal-img" src="" alt="Full size figure">
    </div>

    <script>
        // Multi-select functionality
        function toggleDropdown(selectId) {
            const select = document.getElementById(selectId);
            const dropdown = select.querySelector('.multi-select-dropdown');
            const btn = select.querySelector('.multi-select-btn');

            // Close other dropdowns
            document.querySelectorAll('.multi-select-dropdown.open').forEach(d => {
                if (d !== dropdown) {
                    d.classList.remove('open');
                    d.parentElement.querySelector('.multi-select-btn').classList.remove('open');
                }
            });

            dropdown.classList.toggle('open');
            btn.classList.toggle('open');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.multi-select')) {
                document.querySelectorAll('.multi-select-dropdown.open').forEach(d => {
                    d.classList.remove('open');
                    d.parentElement.querySelector('.multi-select-btn').classList.remove('open');
                });
            }
        });

        // Handle option selection
        document.querySelectorAll('.multi-select-option').forEach(option => {
            option.addEventListener('click', function(e) {
                if (e.target.tagName === 'INPUT') return; // Let checkbox handle itself

                const checkbox = this.querySelector('input[type="checkbox"]');
                checkbox.checked = !checkbox.checked;
                handleOptionChange(this);
            });

            option.querySelector('input').addEventListener('change', function() {
                handleOptionChange(option);
            });
        });

        function handleOptionChange(option) {
            const selectEl = option.closest('.multi-select');
            const value = option.getAttribute('data-value');
            const checkbox = option.querySelector('input');

            // If "All" is selected, uncheck others
            if (value === 'all' && checkbox.checked) {
                selectEl.querySelectorAll('.multi-select-option').forEach(opt => {
                    if (opt.getAttribute('data-value') !== 'all') {
                        opt.querySelector('input').checked = false;
                        opt.classList.remove('selected');
                    }
                });
            }
            // If something else is selected, uncheck "All"
            else if (value !== 'all' && checkbox.checked) {
                const allOption = selectEl.querySelector('.multi-select-option[data-value="all"]');
                if (allOption) {
                    allOption.querySelector('input').checked = false;
                    allOption.classList.remove('selected');
                }
            }

            option.classList.toggle('selected', checkbox.checked);
            updateButtonText(selectEl);
            updateTags(selectEl);
            filterFigures();
        }

        function updateButtonText(selectEl) {
            const btn = selectEl.querySelector('.btn-text');
            const selected = getSelectedValues(selectEl);

            if (selected.includes('all') || selected.length === 0) {
                btn.textContent = selectEl.id === 'outcomeMultiSelect' ? 'All Outcomes' : 'All Splits';
            } else if (selected.length === 1) {
                btn.textContent = selected[0];
            } else {
                btn.textContent = `${selected.length} selected`;
            }
        }

        function updateTags(selectEl) {
            const tagsContainer = document.getElementById(selectEl.id === 'outcomeMultiSelect' ? 'outcomeTags' : 'splitTags');
            const selected = getSelectedValues(selectEl);

            if (selected.includes('all') || selected.length === 0) {
                tagsContainer.innerHTML = '';
                return;
            }

            tagsContainer.innerHTML = selected.map(val =>
                `<span class="selected-tag">${val}<span class="remove" onclick="removeSelection('${selectEl.id}', '${val}')">&times;</span></span>`
            ).join('');
        }

        function removeSelection(selectId, value) {
            const selectEl = document.getElementById(selectId);
            const option = selectEl.querySelector(`.multi-select-option[data-value="${value}"]`);
            if (option) {
                option.querySelector('input').checked = false;
                option.classList.remove('selected');
                updateButtonText(selectEl);
                updateTags(selectEl);
                filterFigures();
            }
        }

        function getSelectedValues(selectEl) {
            const selected = [];
            selectEl.querySelectorAll('.multi-select-option input:checked').forEach(cb => {
                selected.push(cb.parentElement.getAttribute('data-value'));
            });
            return selected;
        }

        function selectAll(selectId) {
            const selectEl = document.getElementById(selectId);
            const allOption = selectEl.querySelector('.multi-select-option[data-value="all"]');
            allOption.querySelector('input').checked = true;
            allOption.classList.add('selected');

            selectEl.querySelectorAll('.multi-select-option').forEach(opt => {
                if (opt.getAttribute('data-value') !== 'all') {
                    opt.querySelector('input').checked = false;
                    opt.classList.remove('selected');
                }
            });

            updateButtonText(selectEl);
            updateTags(selectEl);
            filterFigures();
        }

        function clearAll(selectId) {
            const selectEl = document.getElementById(selectId);
            selectEl.querySelectorAll('.multi-select-option').forEach(opt => {
                opt.querySelector('input').checked = false;
                opt.classList.remove('selected');
            });

            updateButtonText(selectEl);
            updateTags(selectEl);
            filterFigures();
        }

        function openModal(img) {
            document.getElementById('modal').classList.add('active');
            document.getElementById('modal-img').src = img.src;
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeModal();
        });

        // Switch between "By Split" and "By Outcome" views
        function switchViewMode() {
            const viewMode = document.getElementById('viewModeSelect').value;
            const bySplitContainer = document.getElementById('bySplitContainer');
            const byOutcomeContainer = document.getElementById('byOutcomeContainer');

            if (viewMode === 'bySplit') {
                bySplitContainer.classList.remove('hidden');
                byOutcomeContainer.classList.add('hidden');
            } else {
                bySplitContainer.classList.add('hidden');
                byOutcomeContainer.classList.remove('hidden');
            }

            filterFigures();
        }

        function filterFigures() {
            const figType = document.getElementById('figTypeSelect').value;
            const sampleType = document.getElementById('sampleSelect').value;
            const selectedOutcomes = getSelectedValues(document.getElementById('outcomeMultiSelect'));
            const selectedSplits = getSelectedValues(document.getElementById('splitMultiSelect'));
            const viewMode = document.getElementById('viewModeSelect').value;

            const showAllOutcomes = selectedOutcomes.includes('all') || selectedOutcomes.length === 0;
            const showAllSplits = selectedSplits.includes('all') || selectedSplits.length === 0;

            // Update all image sources based on sample type
            const sampleSuffix = sampleType === 'balanced' ? '_balanced' : '_unbalanced';
            document.querySelectorAll('img.sample-img').forEach(img => {
                const base = img.getAttribute('data-base');
                const suffix = img.getAttribute('data-suffix');
                if (base && suffix) {
                    img.src = base + sampleSuffix + suffix;
                }
            });

            let visibleSections = 0;

            if (viewMode === 'bySplit') {
                // ======= BY SPLIT VIEW =======
                // Filter sections by split
                document.querySelectorAll('#bySplitContainer .outcome-section').forEach(section => {
                    const sectionSplit = section.getAttribute('data-split');
                    const showSplit = showAllSplits || selectedSplits.includes(sectionSplit);
                    section.classList.toggle('hidden', !showSplit);

                    if (showSplit) {
                        // Filter by outcome category and specific outcomes within visible sections
                        let hasVisibleGroups = false;
                        section.querySelectorAll('[data-category]').forEach(group => {
                            const type = group.getAttribute('data-type');
                            let showType = figType === 'all' || type === figType;

                            if (!showType) {
                                group.classList.add('hidden');
                                return;
                            }

                            // Filter individual figure cards/pairs by outcome name
                            let hasVisibleCards = false;
                            group.querySelectorAll('[data-outcome]').forEach(card => {
                                const outcomeName = card.getAttribute('data-outcome');
                                const showOutcome = showAllOutcomes || selectedOutcomes.includes(outcomeName);
                                card.style.display = showOutcome ? '' : 'none';
                                if (showOutcome) hasVisibleCards = true;
                            });

                            const isVisible = showType && hasVisibleCards;
                            group.classList.toggle('hidden', !isVisible);
                            if (isVisible) hasVisibleGroups = true;
                        });

                        // Hide section if no groups visible
                        if (!hasVisibleGroups) {
                            section.classList.add('hidden');
                        } else {
                            visibleSections++;
                        }
                    }
                });

                // Update section headers visibility for By Split view
                document.querySelectorAll('#bySplitContainer [data-category-header]').forEach(header => {
                    const nextSibling = header.nextElementSibling;
                    if (nextSibling && nextSibling.classList.contains('outcome-section')) {
                        // Check if any sections in this category are visible
                        let hasVisible = false;
                        let el = header.nextElementSibling;
                        while (el && !el.matches('[data-category-header]')) {
                            if (el.matches('.outcome-section:not(.hidden)')) {
                                hasVisible = true;
                                break;
                            }
                            el = el.nextElementSibling;
                        }
                        header.classList.toggle('hidden', !hasVisible);
                    }
                });
            } else {
                // ======= BY OUTCOME VIEW =======
                // Filter sections by outcome
                document.querySelectorAll('#byOutcomeContainer .outcome-section').forEach(section => {
                    const sectionOutcome = section.getAttribute('data-outcome-view');
                    const sectionType = section.getAttribute('data-type');
                    const showOutcome = showAllOutcomes || selectedOutcomes.includes(sectionOutcome);
                    const showType = figType === 'all' || sectionType === figType;

                    if (!showOutcome || !showType) {
                        section.classList.add('hidden');
                        return;
                    }

                    // Filter individual cards/pairs by split within this outcome section
                    let hasVisibleCards = false;
                    section.querySelectorAll('[data-split-view]').forEach(card => {
                        const splitName = card.getAttribute('data-split-view');
                        const showSplit = showAllSplits || selectedSplits.includes(splitName);
                        card.style.display = showSplit ? '' : 'none';
                        if (showSplit) hasVisibleCards = true;
                    });

                    if (hasVisibleCards) {
                        section.classList.remove('hidden');
                        visibleSections++;
                    } else {
                        section.classList.add('hidden');
                    }
                });

                // Update section headers visibility for By Outcome view
                document.querySelectorAll('#byOutcomeContainer [data-outcome-category-header]').forEach(header => {
                    const category = header.getAttribute('data-outcome-category-header');
                    // Check if any sections for this category are visible
                    let hasVisible = false;
                    let el = header.nextElementSibling;
                    while (el && !el.matches('[data-outcome-category-header]')) {
                        if (el.matches('.outcome-section:not(.hidden)')) {
                            hasVisible = true;
                            break;
                        }
                        el = el.nextElementSibling;
                    }
                    header.classList.toggle('hidden', !hasVisible);
                });
            }

            // Update visible count
            document.getElementById('visibleCount').textContent = visibleSections === 0 ? 'None' :
                (showAllSplits && showAllOutcomes && figType === 'all') ? 'All' : visibleSections;
        }

        // Print report function
        function printReport() {
            // Get current filter settings
            const viewMode = document.getElementById('viewModeSelect').value;
            const figType = document.getElementById('figTypeSelect').value;
            const sampleType = document.getElementById('sampleSelect').value;
            const selectedOutcomes = getSelectedValues(document.getElementById('outcomeMultiSelect'));
            const selectedSplits = getSelectedValues(document.getElementById('splitMultiSelect'));

            // Format the filter values for display
            const viewModeLabel = viewMode === 'bySplit' ? 'By Split' : 'By Outcome';
            const figTypeLabel = figType === 'all' ? 'All Figures' :
                                 figType === 'distributional' ? 'Distributional Only' : 'Standard Only';
            const sampleLabel = sampleType === 'balanced' ? 'Balanced Panel' : 'Unbalanced Panel';

            // Format outcomes
            let outcomesLabel;
            if (selectedOutcomes.includes('all') || selectedOutcomes.length === 0) {
                outcomesLabel = 'All Outcomes';
            } else if (selectedOutcomes.length <= 5) {
                outcomesLabel = selectedOutcomes.join(', ');
            } else {
                outcomesLabel = selectedOutcomes.slice(0, 5).join(', ') + ` (+${selectedOutcomes.length - 5} more)`;
            }

            // Format splits
            let splitsLabel;
            if (selectedSplits.includes('all') || selectedSplits.length === 0) {
                splitsLabel = 'All Splits';
            } else if (selectedSplits.length <= 4) {
                splitsLabel = selectedSplits.join(', ');
            } else {
                splitsLabel = selectedSplits.slice(0, 4).join(', ') + ` (+${selectedSplits.length - 4} more)`;
            }

            // Count visible figures
            const visibleCount = document.getElementById('visibleCount').textContent;

            // Populate print header
            const printMeta = document.getElementById('printMeta');
            printMeta.innerHTML = `
                <div class="print-meta-item">
                    <div class="print-meta-label">View Mode</div>
                    <div class="print-meta-value">${viewModeLabel}</div>
                </div>
                <div class="print-meta-item">
                    <div class="print-meta-label">Figure Type</div>
                    <div class="print-meta-value">${figTypeLabel}</div>
                </div>
                <div class="print-meta-item">
                    <div class="print-meta-label">Sample</div>
                    <div class="print-meta-value">${sampleLabel}</div>
                </div>
                <div class="print-meta-item">
                    <div class="print-meta-label">Outcomes</div>
                    <div class="print-meta-value">${outcomesLabel}</div>
                </div>
                <div class="print-meta-item">
                    <div class="print-meta-label">Splits</div>
                    <div class="print-meta-value">${splitsLabel}</div>
                </div>
                <div class="print-meta-item">
                    <div class="print-meta-label">Sections Showing</div>
                    <div class="print-meta-value">${visibleCount}</div>
                </div>
            `;

            // Add timestamp
            const now = new Date();
            const timestamp = now.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('printTimestamp').textContent = `Generated: ${timestamp}`;

            // Trigger print dialog
            window.print();
        }
    </script>
</body>
</html>
